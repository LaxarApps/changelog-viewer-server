{"version":3,"sources":["../../../../../../../home/awilden/work/AS3/laxar/changelog-viewer-server/lib/cached_fetch.es6"],"names":[],"mappings":";;;;;;;;;;;;0BAIwB,aAAa;;yBACnB,YAAY;;;;AAE9B,IAAM,SAAS,GAAG,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;;qBAEtB,YAA0B;OAAxB,QAAQ,yDAAC,SAAS;;AAEhC,OAAM,GAAG,GAAG,SAAN,GAAG;aAAS,IAAI,IAAI,EAAE,CAAC,OAAO,EAAE;IAAA,CAAA;AACtC,OAAM,UAAU,GAAG,SAAb,UAAU,CAAK,IAAa;UAAX,SAAS,GAAX,IAAa,CAAX,SAAS;aAAQ,SAAS,GAAG,GAAG,EAAE,GAAG,QAAQ;IAAA,CAAC;;AAErE,OAAI,KAAK,GAAG,EAAE,CAAC;;AAEf,OAAM,GAAG,GAAG;AACT,aAAO,EAAE,iBAAE,GAAG,EAAE,OAAO,EAAM;AAC1B,aAAM,UAAU,GAAG,KAAK,CAAE,GAAG,CAAE,CAAC;AAChC,aAAI,UAAU,IAAI,UAAU,CAAE,UAAU,CAAE,EAAG;AAC1C,mBAAO,oBAAQ,OAAO,CAAE,UAAU,CAAC,YAAY,CAAE,CAAC;UACpD;;AAED,gBAAO,4BAAO,GAAG,EAAE,EAAE,OAAO,EAAE,OAAO,IAAI,EAAE,EAAE,CAAE,CAC3C,IAAI,CAAE,UAAA,QAAQ,EAAI;AAChB,gBAAI,CAAE,GAAG,EAAE,GAAG,CAAE,CAAC,OAAO,CAAE,MAAG,QAAQ,CAAC,MAAM,EAAG,MAAM,CAAE,CAAC,CAAE,CAAE,GAAG,CAAC,CAAC,EAAG;AACjE,sBAAO,IAAI,CAAC;aACd;AACD,mBAAO,QAAQ,CAAC,IAAI,EAAE,CAAC;UACzB,CAAE,CACF,IAAI,CAAE,UAAA,YAAY,EAAI;AACpB,iBAAK,CAAE,GAAG,CAAE,GAAG,EAAE,YAAY,EAAZ,YAAY,EAAE,SAAS,EAAE,GAAG,EAAE,EAAE,CAAC;AAClD,mBAAO,YAAY,CAAC;UACtB,CAAE,CAAC;OACT;AACD,aAAO,EAAE,iBAAE,GAAG,EAAE,OAAO;gBAAM,GAAG,CAAC,OAAO,CAAE,GAAG,EAAE,OAAO,CAAE,CAAC,IAAI,CAAE,UAAA,IAAI;mBAAI,IAAI,GAAG,IAAI,CAAC,KAAK,CAAE,IAAI,CAAE,GAAG,IAAI;UAAA,CAAE;OAAA;IAC3G,CAAC;;AAEF,UAAO,GAAG,CAAC;CAEb","file":"cached_fetch.js","sourcesContent":["/**\n * Copyright 2015 aixigo AG\n * Released under the MIT license.\n */\nimport { Promise } from 'es6-promise';\nimport fetch from 'node-fetch';\n\nconst TWO_HOURS = 2 * 60 * 60 * 1000;\n\nexport default ( maxAgeMs=TWO_HOURS ) => {\n\n   const now = () => new Date().getTime()\n   const stillValid = ( { timestamp } ) => timestamp > now() - maxAgeMs;\n\n   let cache = {};\n\n   const api = {\n      getText: ( url, headers ) => {\n         const cacheEntry = cache[ url ];\n         if( cacheEntry && stillValid( cacheEntry ) ) {\n            return Promise.resolve( cacheEntry.responseData );\n         }\n\n         return fetch( url, { headers: headers || {} } )\n            .then( response => {\n               if( [ '4', '5' ].indexOf( `${response.status}`.charAt( 0 ) ) > -1 ) {\n                  return null;\n               }\n               return response.text();\n            } )\n            .then( responseData => {\n               cache[ url ] = { responseData, timestamp: now() };\n               return responseData;\n            } );\n      },\n      getJson: ( url, headers ) => api.getText( url, headers ).then( text => text ? JSON.parse( text ) : null )\n   };\n\n   return api;\n\n}\n"]}